<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mi Cultivo</title>

<link rel="stylesheet" href="../css/styles.css">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0f1f17;
  color: #eaffea;
  padding: 20px;
}

h1 { text-align:center; }

.baldes {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  max-width: 480px;
  margin: auto;
}

.balde {
  padding: 15px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  color: white;
  background-size: cover;
  background-position: center;
  position: relative;
}

.balde::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.45);
  border-radius: 10px;
}

.balde span {
  position: relative;
  z-index: 2;
}

.estado-ok { background-color: #2d6a4f; }
.estado-at { background-color: #b08900; }
.estado-mal { background-color: #9b2226; }

.panel {
  background: #1b4332;
  padding: 20px;
  max-width: 640px;
  margin: 20px auto;
  border-radius: 12px;
  background-size: cover;
  background-position: center;
}

.oculto { display: none; }

label { display:block;margin-top:10px; }

input, textarea {
  width: 100%;
  padding: 6px;
  border-radius: 5px;
  border: none;
}

button {
  margin-top: 10px;
  padding: 10px;
  width: 100%;
  background: #52b788;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

button.borrar { background: #9b2226; }

table {
  width: 100%;
  margin-top: 15px;
  border-collapse: collapse;
  font-size: 12px;
}

th, td {
  border: 1px solid #40916c;
  padding: 4px;
}

#mensajeEstado {
  margin-top: 12px;
  padding: 10px;
  border-radius: 8px;
  background: rgba(0,0,0,0.25);
}
</style>
</head>

<body>

<h1>üå± Mi Cultivo</h1>

<div class="baldes" id="baldes"></div>

<div id="panel" class="panel oculto">
  <h2 id="tituloBalde"></h2>
  <div id="mensajeEstado"></div>

  <label>Gen√©tica</label>
  <input id="genetica">

  <label>üì∏ Foto</label>
  <input type="file" id="fotoBalde" accept="image/*">

  <form id="registroForm">
    <label>Semana</label>
    <input type="week" id="semana" required>

    <label>pH</label>
    <input type="number" step="0.1" id="ph">

    <label>EC</label>
    <input type="number" step="0.1" id="ec">

    <label>Grow</label>
    <input type="number" step="0.1" id="grow">

    <label>Micro</label>
    <input type="number" step="0.1" id="micro">

    <label>Bloom</label>
    <input type="number" step="0.1" id="bloom">

    <button>üíæ Guardar semana</button>
  </form>

  <label>üìù Observaciones</label>
  <textarea id="observaciones" rows="4"></textarea>

  <button id="borrarHistorial" class="borrar">üóëÔ∏è Cerrar ciclo</button>

  <div id="historial"></div>
</div>

<script>
const Cultivo = (() => {

  const baldesDiv = document.getElementById("baldes");
  const panel = document.getElementById("panel");
  const tituloBalde = document.getElementById("tituloBalde");
  const mensajeEstado = document.getElementById("mensajeEstado");
  const genetica = document.getElementById("genetica");
  const fotoBalde = document.getElementById("fotoBalde");
  const registroForm = document.getElementById("registroForm");
  const semana = document.getElementById("semana");
  const ph = document.getElementById("ph");
  const ec = document.getElementById("ec");
  const grow = document.getElementById("grow");
  const micro = document.getElementById("micro");
  const bloom = document.getElementById("bloom");
  const historial = document.getElementById("historial");
  const observaciones = document.getElementById("observaciones");

  let baldeActual = null;

  const key = (n,s) => `cultivo_${n}_${s}`;

  const icono = e => e==="ok"?"üü¢ OK":e==="at"?"üü° ATENCI√ìN":"üî¥ ALERTA";

  const evaluar = (ph,ec)=>{
    let estado="ok", msgs=[];
    if(ph<5.5||ph>6.5){estado="mal";msgs.push("‚ö†Ô∏è pH fuera de rango");}
    else if(ph<5.8||ph>6.2){estado="at";msgs.push("üü° pH sub√≥ptimo");}
    if(ec<1)msgs.push("üü° EC baja");
    if(ec>2.5){estado="mal";msgs.push("üî¥ EC alta");}
    if(!msgs.length)msgs.push("üü¢ Par√°metros √≥ptimos");
    return {estado,msgs};
  };

  const actualizarBalde = n=>{
    const g=localStorage.getItem(key(n,"gen"))||"Sin gen√©tica";
    const e=localStorage.getItem(key(n,"estado"))||"ok";
    const b=document.getElementById(`balde${n}`);
    b.className=`balde estado-${e}`;
    b.innerHTML=`<span>ü™£ Balde ${n}<br><small>${g}</small></span>`;
    aplicarFoto(n);
  };

  const aplicarFoto = n=>{
    const f=localStorage.getItem(key(n,"foto"));
    const b=document.getElementById(`balde${n}`);
    b.style.backgroundImage=f?`url(${f})`:"";
    panel.style.backgroundImage=f?`url(${f})`:"";
  };

  const abrir = n=>{
    baldeActual=n;
    panel.classList.remove("oculto");
    tituloBalde.textContent=`Balde ${n}`;
    genetica.value=localStorage.getItem(key(n,"gen"))||"";
    observaciones.value=localStorage.getItem(key(n,"obs"))||"";
    cargarHistorial();
    aplicarFoto(n);
  };

  genetica.onchange=()=>{
    localStorage.setItem(key(baldeActual,"gen"),genetica.value);
    actualizarBalde(baldeActual);
  };

  fotoBalde.onchange=e=>{
    const f=e.target.files[0];
    if(!f)return;
    const r=new FileReader();
    r.onload=()=>{
      localStorage.setItem(key(baldeActual,"foto"),r.result);
      aplicarFoto(baldeActual);
    };
    r.readAsDataURL(f);
  };

  registroForm.onsubmit=e=>{
    e.preventDefault();
    const ev=evaluar(ph.value,ec.value);
    localStorage.setItem(
      key(baldeActual,semana.value),
      JSON.stringify({semana:semana.value,ph:ph.value,ec:ec.value,estado:ev.estado,msgs:ev.msgs})
    );
    localStorage.setItem(key(baldeActual,"estado"),ev.estado);
    cargarHistorial();
    actualizarBalde(baldeActual);
    registroForm.reset();
  };

  const cargarHistorial=()=>{
    const ks=Object.keys(localStorage)
      .filter(k=>k.startsWith(`cultivo_${baldeActual}_`)&&k.includes("W"))
      .sort();
    let h="<table><tr><th>Semana</th><th>pH</th><th>EC</th><th>Estado</th></tr>";
    let u=null;
    ks.forEach(k=>{
      const d=JSON.parse(localStorage[k]);
      u=d;
      h+=`<tr><td>${d.semana}</td><td>${d.ph}</td><td>${d.ec}</td><td>${icono(d.estado)}</td></tr>`;
    });
    historial.innerHTML=h+"</table>";
    if(u)mensajeEstado.innerHTML=`<strong>${icono(u.estado)}</strong><ul>${u.msgs.map(m=>`<li>${m}</li>`).join("")}</ul>`;
  };

  document.getElementById("borrarHistorial").onclick=()=>{
    if(!confirm("¬øCerrar ciclo?"))return;
    Object.keys(localStorage)
      .filter(k=>k.startsWith(`cultivo_${baldeActual}_`))
      .forEach(k=>localStorage.removeItem(k));
    historial.innerHTML="";
    mensajeEstado.innerHTML="";
    actualizarBalde(baldeActual);
  };

  for(let i=1;i<=9;i++){
    const b=document.createElement("button");
    b.id=`balde${i}`;
    b.onclick=()=>abrir(i);
    baldesDiv.appendChild(b);
    actualizarBalde(i);
  }

})();
</script>

</body>
</html>

